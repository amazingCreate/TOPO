<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8" />
		<title></title>
	</head>
	<style>
		body {
			margin: 0;
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
			width: 100%;
			height: 100%;
			overflow: hidden;
		}
		
		.tool {
			font-size: 12px;
			height: 450px;
			width: 150px;
			text-align: center;
		}
		
		.tool span {
			display: inline-block;
			position: relative;
			height: 80px;
			width: 50px;
			margin: 15px;
			background-color: rgba(255, 255, 255, 0.5);
		}
		
		.tool div {
			position: absolute;
			top: 29px;
			width: 100%;
			text-align: center;
			height: 32px;
			z-index: 9;
		}
		
		#canvas {
			position: absolute;
			left: 150px;
			top: 0px;
			z-index: 1;
		}
		
		#jtopo_textfield {
			z-index: 999999;
		}
		
		li {
			list-style-type: none;
		}
		
		.class-name {
			height: 20px!important;
			background-color: #000!important;
			color: #fff!important;
			font-size: 20px;
			font-weight: bold;
			width: 100%!important;
			margin: 0!important;
		}
		
		#contextmenu {
			border: 1px solid #aaa;
			border-bottom: 0;
			background: #eee;
			position: absolute;
			list-style: none;
			margin: 0;
			padding: 0;
			display: none;
			z-index: 2;
		}
		
		#contextmenu li a {
			display: block;
			padding: 10px;
			border-bottom: 1px solid #aaa;
			cursor: pointer;
		}
		
		#contextmenu li a:hover {
			background: #fff;
		}
	</style>

	<body>
		<div class="tool"></div>
		<textarea id="jtopo_textfield" style="display:none;width: 60px;position: absolute;" onkeydown="if(event.keyCode==13)this.blur();"></textarea>

		<canvas id="canvas" height="450px" width="450px"></canvas>
		<ul id="contextmenu" style="display:none;">
			<li>
				<a>顺时针旋转</a>
			</li>
			<li>
				<a>逆时针旋转</a>
			</li>
			<li>
				<a>更改颜色</a>
			</li>
			<li>
				<a>放大</a>
			</li>
			<li>
				<a>缩小</a>
			</li>
			<li>
				<a>删除该节点</a>
			</li>
		</ul>
	</body>
	<script type="text/javascript" src="js/jquery-1.6.4.js"></script>
	<script type="text/javascript" src="js/topo.js"></script>
	<script type="text/javascript" src="js/draggabilly.js"></script>
	<script type="text/javascript" src="js/lsvih.js"></script>
	<script type="text/javascript" src="js/jquery.mousewheel.js"></script>
	<script>
		var classList = ["IT", "ICS", "医疗", "无线电", "通用符号"];
		//初始数据
		var type = [{
			"id": 0,
			"class": "ICS",
			"name": "DCS"
		}, {
			"id": 1,
			"class": "ICS",
			"name": "IDS（入侵检测系统）"
		}, {
			"id": 2,
			"class": "ICS",
			"name": "IPS"
		}, {
			"id": 3,
			"class": "ICS",
			"name": "PLC"
		}, {
			"id": 4,
			"class": "ICS",
			"name": "RTU（远程终端设备）"
		}, {
			"id": 5,
			"class": "ICS",
			"name": "SCADA服务器或主终端服务单元"
		}, {
			"id": 6,
			"class": "ICS",
			"name": "人机界面接口（HMI）"
		}, {
			"id": 7,
			"class": "ICS",
			"name": "前端处理器"
		}, {
			"id": 8,
			"class": "ICS",
			"name": "功能安全设备系统"
		}, {
			"id": 9,
			"class": "ICS",
			"name": "单向装置"
		}, {
			"id": 10,
			"class": "ICS",
			"name": "历史数据库"
		}, {
			"id": 11,
			"class": "ICS",
			"name": "工程师站"
		}, {
			"id": 12,
			"class": "ICS",
			"name": "智能电子设备"
		}, {
			"id": 13,
			"class": "ICS",
			"name": "终端服务器"
		}, {
			"id": 14,
			"class": "ICS",
			"name": "配置服务器"
		}, {
			"id": 15,
			"class": "IT",
			"name": "DNS服务器"
		}, {
			"id": 16,
			"class": "IT",
			"name": "IP phone"
		}, {
			"id": 17,
			"class": "IT",
			"name": "IP 摄像头"
		}, {
			"id": 18,
			"class": "IT",
			"name": "PC"
		}, {
			"id": 19,
			"class": "IT",
			"name": "RFID发射器"
		}, {
			"id": 20,
			"class": "IT",
			"name": "VLAN交换机"
		}, {
			"id": 21,
			"class": "IT",
			"name": "VLAN路由器"
		}, {
			"id": 22,
			"class": "IT",
			"name": "VPN"
		}, {
			"id": 23,
			"class": "IT",
			"name": "Web Server"
		}, {
			"id": 24,
			"class": "IT",
			"name": "不间断电源"
		}, {
			"id": 25,
			"class": "IT",
			"name": "串口交换机"
		}, {
			"id": 26,
			"class": "IT",
			"name": "互动电视"
		}, {
			"id": 27,
			"class": "IT",
			"name": "交换机"
		}, {
			"id": 28,
			"class": "IT",
			"name": "光环网系统"
		}, {
			"id": 29,
			"class": "IT",
			"name": "公用电话亭（公共信息亭）"
		}, {
			"id": 30,
			"class": "IT",
			"name": "应用服务器"
		}, {
			"id": 31,
			"class": "IT",
			"name": "手持无线设备"
		}, {
			"id": 32,
			"class": "IT",
			"name": "打印机"
		}, {
			"id": 33,
			"class": "IT",
			"name": "数据库服务器"
		}, {
			"id": 34,
			"class": "IT",
			"name": "无线Modem"
		}, {
			"id": 35,
			"class": "IT",
			"name": "无线串口"
		}, {
			"id": 36,
			"class": "IT",
			"name": "无线网络"
		}, {
			"id": 37,
			"class": "IT",
			"name": "无线路由器"
		}, {
			"id": 38,
			"class": "IT",
			"name": "时钟"
		}, {
			"id": 39,
			"class": "IT",
			"name": "服务器"
		}, {
			"id": 40,
			"class": "IT",
			"name": "楼宇自动管理系统"
		}, {
			"id": 41,
			"class": "IT",
			"name": "活动目录服务器"
		}, {
			"id": 42,
			"class": "IT",
			"name": "电子保安系统"
		}, {
			"id": 43,
			"class": "IT",
			"name": "网络扫描仪和复印机"
		}, {
			"id": 44,
			"class": "IT",
			"name": "虚拟机"
		}, {
			"id": 45,
			"class": "IT",
			"name": "视频会议装置"
		}, {
			"id": 46,
			"class": "IT",
			"name": "调制解调器"
		}, {
			"id": 47,
			"class": "IT",
			"name": "路由器"
		}, {
			"id": 48,
			"class": "IT",
			"name": "远程接入服务器"
		}, {
			"id": 49,
			"class": "IT",
			"name": "连接加密"
		}, {
			"id": 50,
			"class": "IT",
			"name": "邮件服务器"
		}, {
			"id": 51,
			"class": "IT",
			"name": "门禁单元"
		}, {
			"id": 52,
			"class": "IT",
			"name": "防火墙"
		}, {
			"id": 53,
			"class": "IT",
			"name": "集线器"
		}, {
			"id": 54,
			"class": "医疗",
			"name": "CT 扫描机"
		}, {
			"id": 55,
			"class": "医疗",
			"name": "X射线发生器"
		}, {
			"id": 56,
			"class": "医疗",
			"name": "内窥镜系统"
		}, {
			"id": 57,
			"class": "医疗",
			"name": "医用气体系统"
		}, {
			"id": 58,
			"class": "医疗",
			"name": "婴儿保护远程显示单元"
		}, {
			"id": 59,
			"class": "医疗",
			"name": "定时定位系统"
		}, {
			"id": 60,
			"class": "医疗",
			"name": "尿动力学诊断设备"
		}, {
			"id": 61,
			"class": "医疗",
			"name": "心电图"
		}, {
			"id": 62,
			"class": "医疗",
			"name": "成像方式与设备"
		}, {
			"id": 63,
			"class": "医疗",
			"name": "成像服务器"
		}, {
			"id": 64,
			"class": "医疗",
			"name": "核磁共振成像系统"
		}, {
			"id": 65,
			"class": "医疗",
			"name": "生理监测系统"
		}, {
			"id": 66,
			"class": "医疗",
			"name": "紧急医疗服务硬件"
		}, {
			"id": 67,
			"class": "医疗",
			"name": "线性粒子加速器"
		}, {
			"id": 68,
			"class": "医疗",
			"name": "脑电图"
		}, {
			"id": 69,
			"class": "医疗",
			"name": "表皮肌电图"
		}, {
			"id": 70,
			"class": "医疗",
			"name": "超声波"
		}, {
			"id": 71,
			"class": "医疗",
			"name": "输液泵"
		}, {
			"id": 72,
			"class": "无线电",
			"name": "T1回传单元"
		}, {
			"id": 73,
			"class": "无线电",
			"name": "TDM(时分复用）回传网络"
		}, {
			"id": 74,
			"class": "无线电",
			"name": "中继器"
		}, {
			"id": 75,
			"class": "无线电",
			"name": "主站"
		}, {
			"id": 76,
			"class": "无线电",
			"name": "以太网回传系统"
		}, {
			"id": 77,
			"class": "无线电",
			"name": "微波回传网络"
		}, {
			"id": 78,
			"class": "无线电",
			"name": "无线发送接收站"
		}, {
			"id": 79,
			"class": "无线电",
			"name": "订户"
		}, {
			"id": 80,
			"class": "无线电",
			"name": "调派控制台"
		}, {
			"id": 81,
			"class": "无线电",
			"name": "音频交换机"
		}, {
			"id": 82,
			"class": "通用符号",
			"name": "Web"
		}, {
			"id": 83,
			"class": "通用符号",
			"name": "伙伴"
		}, {
			"id": 84,
			"class": "通用符号",
			"name": "区域"
		}, {
			"id": 85,
			"class": "通用符号",
			"name": "厂商"
		}, {
			"id": 86,
			"class": "通用符号",
			"name": "未知"
		}, {
			"id": 87,
			"class": "通用符号",
			"name": "连接点"
		}, ];
		var nodes = [];
		var links = [];
		fInitTools(classList, type);

		//每个node都有一个独一无二的id,对应数据中的id
		var canvas;
		var scene;
		var stage;
		var currentNode;
		$(document).ready(function() {
			canvas = document.getElementById('canvas');
			stage = new JTopo.Stage(canvas);
			scene = new JTopo.Scene(stage);
			$(".tool").css({
				height: PAGE_HEIGHT
			});
			$('li').each(function() {
				tool_max_margin += $(this).height()
			});
			$('.tool').mousewheel(function(event, delta) {
				if(tool_margin + delta > 0) {
					$('.tool').css({
						marginTop: 0
					})
				} else if(tool_margin + delta < PAGE_HEIGHT - tool_max_margin) {
					$('.tool').css({
						marginTop: PAGE_HEIGHT - tool_max_margin
					})
				} else {
					tool_margin += delta;
					$('.tool').css({
						marginTop: tool_margin
					})
				}

			});
			canvas.width = PAGE_WIDTH - TOOL_BAR_WIDTH;
			canvas.height = PAGE_HEIGHT;
			scene.background = 'img/bg.jpg';
			for(var i = 0; i < nodes.length; i++) { //遍历已有的节点数组，将节点加入对象中
				scene.add(nodes);
			}
			for(var j = 0; j < links.length; j++) { //遍历已有的连线数组
				scene.add(links[j]);
			}
			var beginNode = null;
			var tempNodeA = new JTopo.Node('tempA');;
			tempNodeA.setSize(1, 1);

			var tempNodeZ = new JTopo.Node('tempZ');;
			tempNodeZ.setSize(1, 1);

			var link = new JTopo.Link(tempNodeA, tempNodeZ);

			scene.click(function(e) {
				if(e.button == 2) {
					scene.remove(link);
					beginNode = null;
					return;
				}
				if(e.target != null && e.target instanceof JTopo.Node) {
					if(beginNode == null) {
						beginNode = e.target;
						scene.add(link);
						tempNodeA.setLocation(e.x, e.y);
						tempNodeZ.setLocation(e.x, e.y);
					} else if(beginNode !== e.target) { //当连线的起点与终点不在同一点时创建连线
						var endNode = e.target;
						var l = new JTopo.Link(beginNode, endNode);
						l.arrowsRadius = 15;
						links.push(l); //将新增的连线存入数组
						scene.add(l);
						beginNode = null;
						scene.remove(link);
					} else {
						beginNode = null;
					}
				} else {
					scene.remove(link);
					beginNode = null;
				}
			});

			scene.mouseup(function(event) {
				if(event.target == null) return;
				if(event.target.elementType == "node") {
					currentNode = event.target;
					if(event.which == 3) {
						$("#contextmenu").css({
							top: event.pageY,
							left: event.pageX
						}).show();
					}

				}
			});
			scene.mousedown(function(e) { //当连线没有连上目标时释放连线
				$("#contextmenu").hide();
				if(e.target == null || e.target === beginNode || e.target === link) {
					scene.remove(link);
				}
			});
			scene.mousemove(function(e) {
				tempNodeZ.setLocation(e.x, e.y);
			});
			//双击更改当前节点文字内容
			var textfield = $("#jtopo_textfield");
			scene.dbclick(function(event) {
				if(event.target == null) return;
				if(event.target.elementType == "node") {
					var e = event.target;
					textfield.css({
						top: event.pageY - scene.translateY - e.height / 2,
						left: event.pageX - e.width / 2 - scene.translateX
					}).show().attr('value', e.text).attr('data-id', e._id).focus().select();
					e.text = "";
					textfield[0].JTopoNode = e;
				}

			});
			//结束拖动更新节点数据的坐标
			//限制条件，右键不更新坐标
			scene.mouseup(function(event) {
				if(event.target == null || event.which == 3) return;
				if(event.target.elementType == "node") {
					var e = event.target;
					var thisnode = nodes[lsvih.array.getSubByKey({
						"_id": e._id
					}, nodes)];
					thisnode.y = event.pageY - scene.translateY - e.height / 2;
					thisnode.x = event.pageX - TOOL_BAR_WIDTH - scene.translateX - e.width / 2;
				}
			});
			//改变节点数据的文字内容
			$("#jtopo_textfield").blur(function() {
				nodes[lsvih.array.getSubByKey({
					"_id": textfield.attr("data-id")
				}, nodes)].text = textfield.attr('value');
				textfield[0].JTopoNode.text = textfield.hide().val();
			});
		});
		/**
		 * 初始化拖动控件
		 */
		function fInitDrag() {
			//拖动工具箱中的控件到画布中。
			var draggableElems = document.querySelectorAll('.tool div');
			var draggies = [];
			for(var i = 0, len = draggableElems.length; i < len; i++) {
				var draggableElem = draggableElems[i];
				var draggie = new Draggabilly(draggableElem);
				draggies.push(draggie);
			}
			//落点在画布内
			for(var i = 0, len = draggies.length; i < len; i++) {
				draggies[i].on('dragEnd', function(event, pointer) {
					x = pointer.pageX;
					y = pointer.pageY;
					if(x >= TOOL_BAR_WIDTH && x <= PAGE_WIDTH && y >= 0 && y <= PAGE_HEIGHT) {
						fAddNode(this.element.getAttribute("data-class"), this.element.parentNode.innerText, x - TOOL_BAR_WIDTH - scene.translateX, y - scene.translateY)
					}
					this.element.style.left = "0";
					this.element.style.top = "29px";
					return true;
				});
			}
		}
		//右键菜单模块
		$("#contextmenu a").click(function() {
			var text = $(this).text();
			if(text == '删除该节点') {
				fDelNode(currentNode);
				currentNode = null;
			}
			if(text == '更改颜色') {
				currentNode.fillColor = JTopo.util.randomColor();
			} else if(text == '顺时针旋转') {
				currentNode.rotate += 0.5;
			} else if(text == '逆时针旋转') {
				currentNode.rotate -= 0.5;
			} else if(text == '放大') {
				currentNode.scaleX += 0.2;
				currentNode.scaleY += 0.2;
			} else if(text == '缩小') {
				currentNode.scaleX -= 0.2;
				currentNode.scaleY -= 0.2;
			}
			$("#contextmenu").hide();
		});
		var TOOL_BAR_WIDTH = 150;
		var PAGE_WIDTH = window.innerWidth;
		var PAGE_HEIGHT = window.innerHeight;
		var tool_margin = 0;
		var tool_max_margin = 0;

		/**
		 * 初始化工具栏
		 * @param {Array} classList
		 * @param {Array} typeList
		 */
		function fInitTools(classList, typeList) {
			for(var i = 0; i < classList.length; i++) {
				var classObj = document.createElement("li");
				classObj.className = "class";
				classObj.innerHTML = '<span class="class-name">' + classList[i] + '</span>';
				$(".tool").append(classObj);
				for(var j = 0; j < typeList.length; j++) {
					if(typeList[j].class == classList[i]) {
						var toolObj = document.createElement("span");
						toolObj.innerHTML = typeList[j].name + '<div data-class="' + classList[i] + '" onmousedown="$(this,event)"><img src="img/' + classList[i] + '/' + typeList[j].name + '.png"></div>'
						$(".tool .class:eq(" + i + ")").append(toolObj);
					}
				}
			}
			fInitDrag();

		}

		/**
		 * 根据id在指定数组查找元素的下标
		 * @param {Number} id
		 */
		function fFindNodeSortById(id) {
			var name;
			for(var s in nodes) {
				if(nodes[s].id == id) name = nodes[s].name;
			}
			for(var k in scene.childs) {
				if(scene.childs[k].elementType == 'node' && scene.childs[k].text == name) return k;
			}
		}

		/**
		 * 增加节点
		 * @param {Number} nodeType 输入节点的类型
		 * @param {Number} x 节点x坐标
		 * @param {Number} y 节点y坐标
		 */
		function fAddNode(nodeClass, nodeType, x, y) {
			var nodenum = nodes.length;
			var node = new JTopo.Node(nodeType + (nodenum + 1));
			node.setSize(44, 44);
			node.setImage('./img/' + nodeClass + '/' + nodeType + '.png', true);
			node.setLocation(x, y);
			nodes.push(node);
			scene.add(node);
			return node;
		}
		/**
		 * 找到父节点
		 * @param {Object} node
		 */
		function fFindPrevNodes(node) {
			var prevNodes = [];
			var inlinks = node.inLinks;
			for(var i = 0; i < inlinks; i++) {
				prevNodes.push(inlinks[i].nodeA);
			}
			return prevNodes;
		}

		/**
		 * 找到子节点
		 * @param {Object} node
		 */
		function fFindNextNodes(node) {
			var nextNodes = [];
			var outlinks = node.outLinks;
			for(var s = 0; s < outlinks.length; s++) {
				nextNodes.push(outlinks[s]);
			}
			return nextNodes;
		}

		/**
		 * 删除节点及其有关的连线
		 * @param {Object} node
		 */
		function fDelNode(node) {
			lsvih.array.delObjByKey({
				"_id": node._id
			}, nodes);
			var outlinks = node.outLinks;
			var inlinks = node.inLinks;
			for(var a = 0; a < outlinks.length; a++) {
				lsvih.array.delObjByKey({
					"_id": outlinks[a]._id
				}, links)
			}
			for(var a = 0; a < inlinks.length; a++) {
				lsvih.array.delObjByKey({
					"_id": inlinks[a]._id
				}, links)
			}
			scene.remove(node);
		}

		/**
		 * 节点报警
		 * @param {Object} node
		 * @param {String} msg
		 */
		function fNodeAlert(node, msg) {
			if(node.alarm){
				node.alarm += 'msg||"Warrning"';
			}else{
				node.alarm = msg||"Warrning";
			}
			node.alarmColor = '255,0,0';
			node.alarmAlpha = 0.9;
		}
		
		/**
		 * 线报警
		 * @param {Object} link
		 */
		function fLinkAlert(link){
			link.strokeColor = '255,0,0,';
		}
	</script>

</html>