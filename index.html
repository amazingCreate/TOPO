<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8" />
		<title></title>
	</head>
	<style>
		body {
			margin: 0;
			-webkit-touch-callout: none;
			-webkit-user-select: none;
			-khtml-user-select: none;
			-moz-user-select: none;
			-ms-user-select: none;
			user-select: none;
			width: 100%;
			height: 100%;
			overflow: hidden;
		}
		
		.tool {
			font-size: 12px;
			height: 450px;
			width: 150px;
			text-align: center;
		}
		
		.tool span {
			display: inline-block;
			position: relative;
			height: 80px;
			width: 50px;
			margin: 15px;
			background-color: rgba(255, 255, 255, 0.5);
		}
		
		.tool div {
			position: absolute;
			top: 29px;
			width: 100%;
			text-align: center;
			height: 32px;
			z-index: 9;
		}
		
		#canvas {
			position: absolute;
			left: 150px;
			top: 0px;
			z-index: 1;
		}
		
		#jtopo_textfield {
			z-index: 999999;
		}
		
		li {
			list-style-type: none;
		}
		
		.class-name {
			height: 20px!important;
			background-color: #000!important;
			color: #fff!important;
			font-size: 20px;
			font-weight: bold;
			width: 100%!important;
			margin: 0!important;
		}
		
		.contextmenu {
			border: 1px solid #aaa;
			border-bottom: 0;
			background: #eee;
			position: absolute;
			list-style: none;
			margin: 0;
			padding: 0;
			display: none;
			z-index: 2;
		}
		
		.contextmenu li a {
			display: block;
			padding: 10px;
			border-bottom: 1px solid #aaa;
			cursor: pointer;
		}
		
		.contextmenu li a:hover {
			background: #fff;
		}
	</style>

	<body>
		<div class="tool"></div>
		<textarea id="jtopo_textfield" style="display:none;width: 60px;position: absolute;" onkeydown="if(event.keyCode==13)this.blur();"></textarea>

		<canvas id="canvas" height="450px" width="450px"></canvas>
		<ul id="node" class="contextmenu" style="display:none;">
			<li>
				<a>设置节点属性</a>
			</li>
			<li>
				<a>放大</a>
			</li>
			<li>
				<a>缩小</a>
			</li>
			<li>
				<a>删除该节点</a>
			</li>
		</ul>

		<ul id="link" class="contextmenu" style="display:none;">
			<li>
				<a>删除该连线</a>
			</li>
		</ul>

		<ul id="container" class="contextmenu" style="display:none;">
			<li>
				<a>设置区域属性</a>
			</li>
			<li>
				<a>删除该区域</a>
			</li>
		</ul>
	</body>
	<script type="text/javascript" src="js/jquery-1.6.4.js"></script>
	<script type="text/javascript" src="js/topo.js"></script>
	<script type="text/javascript" src="js/draggabilly.js"></script>
	<script type="text/javascript" src="js/lsvih.js"></script>
	<script type="text/javascript" src="js/jquery.mousewheel.js"></script>
	<script type="text/javascript" src="js/topo_data.js"></script>
	<script>
		var nodes = [];
		var links = [];
		var containers = [];
		var canvas;
		var scene;
		var stage;
		var currentNode;
		var currentLink;
		var currentContainer;
		var TOOL_BAR_WIDTH = 150;
		var PAGE_WIDTH = window.innerWidth;
		var PAGE_HEIGHT = window.innerHeight;
		var tool_margin = 0;
		var tool_max_margin = 0;
		fInitTools(classList, type);
		$(document).ready(function() {
			canvas = document.getElementById('canvas');
			stage = new JTopo.Stage(canvas);
			scene = new JTopo.Scene(stage);
			$(".tool").css({
				height: PAGE_HEIGHT
			});
			$('li').each(function() {
				tool_max_margin += $(this).height()
			});
			$('.tool').mousewheel(function(event, delta) {
				if(tool_margin + delta > 0) {
					$('.tool').css({
						marginTop: 0
					})
				} else if(tool_margin + delta < PAGE_HEIGHT - tool_max_margin) {
					$('.tool').css({
						marginTop: PAGE_HEIGHT - tool_max_margin
					})
				} else {
					tool_margin += delta;
					$('.tool').css({
						marginTop: tool_margin
					})
				}

			});
			canvas.width = PAGE_WIDTH - TOOL_BAR_WIDTH;
			canvas.height = PAGE_HEIGHT;
			scene.background = 'img/bg.jpg';
			for(var i = 0; i < nodes.length; i++) { //遍历已有的节点数组，将节点加入对象中
				scene.add(nodes);
			}
			for(var j = 0; j < links.length; j++) { //遍历已有的连线数组
				scene.add(links[j]);
			}
			var beginNode = null;
			var tempNodeA = new JTopo.Node('tempA');;
			tempNodeA.setSize(1, 1);

			var tempNodeZ = new JTopo.Node('tempZ');;
			tempNodeZ.setSize(1, 1);

			var link = new JTopo.Link(tempNodeA, tempNodeZ);

			scene.click(function(e) {
				if(e.button == 2) {
					scene.remove(link);
					beginNode = null;
					return;
				}
				if(e.target != null && e.target instanceof JTopo.Node) {
					if(beginNode == null) {
						beginNode = e.target;
						scene.add(link);
						tempNodeA.setLocation(e.x, e.y);
						tempNodeZ.setLocation(e.x, e.y);
					} else if(beginNode !== e.target) { //当连线的起点与终点不在同一点时创建连线
						var endNode = e.target;
						var l = new JTopo.Link(beginNode, endNode);
						l.arrowsRadius = 15;
						links.push(l); //将新增的连线存入数组
						scene.add(l);
						beginNode = null;
						scene.remove(link);
					} else {
						beginNode = null;
					}
				} else {
					scene.remove(link);
					beginNode = null;
				}
			});
			//右键菜单部分
			scene.mouseup(function(event) {
				if(event.target == null) return;
				switch(event.target.elementType) {
					case 'node':
						currentNode = event.target;
						if(event.which == 3) {
							$("#node").css({
								top: event.pageY,
								left: event.pageX
							}).show();
						}
						break;
					case 'link':
						currentLink = event.target;
						if(event.which == 3) {
							$("#link").css({
								top: event.pageY,
								left: event.pageX
							}).show();
						}
						break;
					case 'container':
						currentContainer = event.target;
						if(event.which == 3) {
							$("#container").css({
								top: event.pageY,
								left: event.pageX
							}).show();
						}
						break;
					default:
						return;
						break;
				}

			});
			scene.mousedown(function(e) { //当连线没有连上目标时释放连线
				$("#node").hide();
				$("#link").hide();
				$("#container").hide();
				if(e.target == null || e.target === beginNode || e.target === link) {
					scene.remove(link);
				}
			});
			scene.mousemove(function(e) {
				tempNodeZ.setLocation(e.x, e.y);
			});
			//双击更改当前节点文字内容
			var textfield = $("#jtopo_textfield");
			scene.dbclick(function(event) {
				if(event.target == null) return;
				if(event.target.elementType == "node") {
					var e = event.target;
					textfield.css({
						top: event.pageY - scene.translateY - e.height / 2,
						left: event.pageX - e.width / 2 - scene.translateX
					}).show().attr('value', e.text).attr('data-id', e._id).focus().select();
					e.text = "";
					textfield[0].JTopoNode = e;
				}

			});
			//改变节点数据的文字内容
			$("#jtopo_textfield").blur(function() {
				nodes[lsvih.array.getSubByKey({
					"_id": textfield.attr("data-id")
				}, nodes)].text = textfield.attr('value');
				textfield[0].JTopoNode.text = textfield.hide().val();
			});
		});
		/**
		 * 初始化拖动控件
		 */
		function fInitDrag() {
			//拖动工具箱中的控件到画布中。
			var draggableElems = document.querySelectorAll('.tool div');
			var draggies = [];
			for(var i = 0, len = draggableElems.length; i < len; i++) {
				var draggableElem = draggableElems[i];
				var draggie = new Draggabilly(draggableElem);
				draggies.push(draggie);
			}
			//落点在画布内
			for(var i = 0, len = draggies.length; i < len; i++) {
				draggies[i].on('dragEnd', function(event, pointer) {
					x = pointer.pageX;
					y = pointer.pageY;
					if(x >= TOOL_BAR_WIDTH && x <= PAGE_WIDTH && y >= 0 && y <= PAGE_HEIGHT) {
						fAddNode(this.element.getAttribute("data-class"), this.element.parentNode.innerText, x - TOOL_BAR_WIDTH - scene.translateX, y - scene.translateY)
					}
					this.element.style.left = "0";
					this.element.style.top = "29px";
					return true;
				});
			}
		}
		//右键菜单模块
		//节点右键
		$("#node a").click(function() {
			var text = $(this).text();
			if(text == '删除该节点') {
				fDelNode(currentNode);
				currentNode = null;
			} else if(text == '放大') {
				currentNode.scaleX += 0.2;
				currentNode.scaleY += 0.2;
			} else if(text == '缩小') {
				currentNode.scaleX -= 0.2;
				currentNode.scaleY -= 0.2;
			}
			$("#node").hide();
		});
		//线右键
		$("#link a").click(function() {
			var text = $(this).text();
			if(text == '删除该连线') {
				fDelLink(currentLink);
				currentNode = null;
			}
			$("#link").hide();
		});

		//区域右键
		$("#container a").click(function() {
			var text = $(this).text();
			if(text == '删除该区域') {
				fDelContainer(currentContainer);
				currentContainer = null;
			}
			$("#container").hide();
		});

		/**
		 * 初始化工具栏
		 * @param {Array} classList
		 * @param {Array} typeList
		 */
		function fInitTools(classList, typeList) {
			for(var i = 0; i < classList.length; i++) {
				var classObj = document.createElement("li");
				classObj.className = "class";
				classObj.innerHTML = '<span class="class-name">' + classList[i] + '</span>';
				$(".tool").append(classObj);
				for(var j = 0; j < typeList.length; j++) {
					if(typeList[j].class == classList[i]) {
						var toolObj = document.createElement("span");
						toolObj.innerHTML = typeList[j].name + '<div data-class="' + classList[i] + '" onmousedown="$(this,event)"><img src="img/' + classList[i] + '/' + typeList[j].name + '.png"></div>'
						$(".tool .class:eq(" + i + ")").append(toolObj);
					}
				}
			}
			fInitDrag();

		}

		/**
		 * 根据id在指定数组查找元素的下标
		 * @param {Number} id
		 */
		function fFindNodeSortById(id) {
			var name;
			for(var s in nodes) {
				if(nodes[s].id == id) name = nodes[s].name;
			}
			for(var k in scene.childs) {
				if(scene.childs[k].elementType == 'node' && scene.childs[k].text == name) return k;
			}
		}

		/**
		 * 增加节点
		 * @param {Number} nodeType 输入节点的类型
		 * @param {Number} x 节点x坐标
		 * @param {Number} y 节点y坐标
		 */
		function fAddNode(nodeClass, nodeType, x, y) {
			var nodenum = nodes.length;
			var node = new JTopo.Node(nodeType + (nodenum + 1));
			node.setSize(44, 44);
			node.setImage('./img/' + nodeClass + '/' + nodeType + '.png', true);
			node.setLocation(x, y);
			nodes.push(node);
			scene.add(node);
			return node;
		}
		/**
		 * 找到父节点
		 * @param {Object} node
		 */
		function fFindPrevNodes(node) {
			var prevNodes = [];
			var inlinks = node.inLinks;
			for(var n = 0; n < inlinks.length; n++) {
				prevNodes.push(inlinks[n].nodeA);
			}
			return prevNodes;
		}

		/**
		 * 找到子节点
		 * @param {Object} node
		 */
		function fFindNextNodes(node) {
			var nextNodes = [];
			var outlinks = node.outLinks;
			for(var s = 0; s < outlinks.length; s++) {
				nextNodes.push(outlinks[s].nodeZ);
			}
			return nextNodes;
		}

		/**
		 * 删除节点及其有关的连线
		 * @param {Object} node
		 */
		function fDelNode(node) {
			lsvih.array.delObjByKey({
				"_id": node._id
			}, nodes);
			var outlinks = node.outLinks;
			var inlinks = node.inLinks;
			for(var a = 0; a < outlinks.length; a++) {
				lsvih.array.delObjByKey({
					"_id": outlinks[a]._id
				}, links)
			}
			for(var a = 0; a < inlinks.length; a++) {
				lsvih.array.delObjByKey({
					"_id": inlinks[a]._id
				}, links)
			}
			scene.remove(node);
		}
		/**
		 * 删除连线
		 * @param {Object} link
		 */
		function fDelLink(link) {
			lsvih.array.delObjByKey({
				"_id": link._id
			}, links)
			scene.remove(link);
		}

		/**
		 * 删除区域
		 * @param {Object} container
		 */
		function fDelContainer(container) {
			lsvih.array.delObjByKey({
				"_id": container._id
			}, containers)
			scene.remove(container);
		}

		/**
		 * 节点报警
		 * @param {Object} node
		 * @param {String} msg
		 */
		function fNodeAlert(node, msg) {
			if(node.alarm) {
				node.alarm += 'msg||"Warrning"';
			} else {
				node.alarm = msg || "Warrning";
			}
			node.alarmColor = '255,0,0';
			node.alarmAlpha = 0.9;
		}

		/**
		 * 线报警
		 * @param {Object} link
		 */
		function fLinkAlert(link) {
			link.strokeColor = '255,0,0';
		}
	</script>

</html>